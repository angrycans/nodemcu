<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>FlyPT 6ËΩ¥ÁîµÁº∏ÊéßÂà∂ HMI</title>

    <style>
        body {
            margin: 0;
            background: #0f0f0f;
            color: #eee;
            font-family: Arial, sans-serif;
        }

        header {
            padding: 10px 20px;
            background: #1b1b1b;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        button.enable {
            background: #2e7d32;
            /* Áªø */
        }

        button.disable {
            background: #8e2424;
            /* Á∫¢ */
        }

        button.home-idle {
            background: #838784;
            /* Áªø */
        }

        button.home-homing {
            background: #ff9800;
            /* Ê©ô */
        }

        button.home-homed {
            background: #4CAF50;
            /* Áªø */
        }

        button.home-failed {
            background: #f6010a;
            /* Áªø */
        }

        button.disable {
            background: #8e2424;
            /* Á∫¢ */
        }


        button {
            background: #333;
            color: #eee;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
        }




        .container {
            display: flex;
            justify-content: space-around;
            padding: 20px;
        }



        .axis {
            width: 170px;
            background: #1a1a1a;
            border-radius: 12px;
            padding: 10px;
        }

        .axis h3 {
            text-align: center;
            margin: 6px 0;
        }

        svg {
            display: block;
            margin: 8px auto;
        }

        label {
            font-size: 13px;
        }

        input[type=number] {
            width: 70px;
        }

        input[type=range] {
            width: 100%;
        }

        .value {
            text-align: center;
            font-size: 13px;
            margin-top: 4px;
            color: #9fdc9f;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
        }
    </style>
</head>

<body>

    <header>
        <button onclick="connect()">üîå ËøûÊé•‰∏≤Âè£</button>

        <button onclick="send('HOME ALL')">üè† Home All</button>
        <span id="status">Êú™ËøûÊé•</span>
    </header>

    <div class="container" id="container"></div>

    <script>
        /* ================= ÈÖçÁΩÆ ================= */
        const AXIS_NUM = 6;
        const SHELL_TOP = 10;
        const SHELL_HEIGHT = 180;
        const ROD_HEIGHT = 20;

        const HOME_IDLE = 0;
        const HOME_HOMING = 1;
        const HOME_HOMED = 2;
        const HOME_FAILED = 3;


        /* ================= Web Serial ================= */
        let port, writer;



        async function connect() {
            port = await navigator.serial.requestPort();
            await port.open({ baudRate: 115200 });
            writer = port.writable.getWriter();
            document.getElementById("status").textContent = "Â∑≤ËøûÊé•";
        }

        function send(cmd) {
            console.log(cmd);
            if (!writer) return;
            writer.write(new TextEncoder().encode(cmd + "\n"));
        }

        /* ================= ËΩ¥Êï∞ÊçÆ ================= */
        let axis = Array.from({ length: AXIS_NUM }, () => ({
            stroke: 100,
            lead: 5.0,
            invert: false,
            target: 0,
            enabled: true,
            homeState: HOME_IDLE   // ‚≠ê ‰∏âÊÄÅ
        }));
        /* ================= SVG ÁªÑ‰ª∂ ================= */
        function axisSVG(i) {
            return `
<svg width="80" height="200">
  <!-- Â§ñÂ£≥ -->
  <rect id="shell${i}" x="20" y="${SHELL_TOP}" width="40" height="${SHELL_HEIGHT}"
        rx="6" fill="#555" stroke="#777"
        stroke-width="2"/>
  <!-- ÊªëÂùó -->
  <rect id="rod${i}" x="28" y="${SHELL_TOP + SHELL_HEIGHT - ROD_HEIGHT}"
        width="24" height="${ROD_HEIGHT}" rx="4" fill="#777"/>
</svg>`;
        }

        /* ================= UI ÊûÑÂª∫ ================= */
        const container = document.getElementById("container");

        axis.forEach((a, i) => {
            container.innerHTML += `
  <div class="axis">
    
    <h3>Axis ${i + 1} <button id="enBtn${i}" onclick="toggleEnable(${i})">
    DISABLED
  </button></h3>

    ${axisSVG(i)}

    <div class="value" id="val${i}">0.0 mm</div>

    <input type="range"
  id="slider${i}"
  min="0"
  max="${a.stroke}"
  value="0"
  oninput="moveAxis(${i}, this.value)">

    <label>Ë°åÁ®ã</label><br>
    <input type="number" value="${a.stroke}"
      onchange="setStroke(${i}, this.value)"> mm<br>

    <label>ÂØºÁ®ã</label><br>
    <input type="number" step="0.1" value="${a.lead}"
      onchange="setLead(${i}, this.value)"> mm/rev<br>

    <label>
      <input type="checkbox"
        onchange="setInvert(${i}, this.checked)">
      ÁîµÊú∫ÂèçÂêë
    </label>

    <div class="controls">
     <div class="controls">
<button id="homeBtn${i}" onclick="homeAxis(${i})">Home</button>
 
</div>

    </div>
  </div>
  `;
        });

        /* ================= ÊéßÂà∂ÈÄªËæë ================= */
        function moveAxis(i, value) {
            if (!(axis[i].enabled && axis[i].homeState === HOME_HOMED)) {
                return;
            }


            axis[i].target = Number(value);
            updateRod(i);

            const sendValue = axis[i].invert
                ? axis[i].stroke - axis[i].target
                : axis[i].target;

            send(`MOVE AXIS ${i} ${sendValue}`);
        }

        function setStroke(i, v) {
            const stroke = Number(v);
            axis[i].stroke = stroke;

            const slider = document.getElementById(`slider${i}`);
            slider.max = stroke;

            // Èò≤Ê≠¢ÁõÆÊ†áË∂ÖÂá∫Êñ∞Ë°åÁ®ã
            if (axis[i].target > stroke) {
                axis[i].target = stroke;
                slider.value = stroke;
            }

            updateRod(i);
            send(`SET STROKE ${i} ${stroke}`);
        }


        function setLead(i, v) {
            axis[i].lead = Number(v);
            send(`SET LEAD ${i} ${v}`);
        }

        function setInvert(i, v) {
            axis[i].invert = v;
            send(`SET INVERT ${i} ${v ? 1 : 0}`);
        }

        /* ================= SVG Êõ¥Êñ∞ ================= */
        function updateRod(i) {
            const a = axis[i];
            const ratio = a.target / a.stroke;
            const maxTravel = SHELL_HEIGHT - ROD_HEIGHT;

            const y = SHELL_TOP + maxTravel * (1 - ratio);

            document.getElementById(`rod${i}`).setAttribute("y", y);
            document.getElementById(`val${i}`).textContent =
                a.target.toFixed(1) + " mm";
        }

        function toggleEnable(i) {
            axis[i].enabled = !axis[i].enabled;

            const btn = document.getElementById(`enBtn${i}`);

            if (axis[i].enabled) {
                btn.textContent = "ENABLED";
                btn.classList.remove("disable");
                btn.classList.add("enable");
                send(`ENABLE AXIS ${i}`);
            } else {
                btn.textContent = "DISABLED";
                btn.classList.remove("enable");
                btn.classList.add("disable");

                axis[i].homeState = HOME_IDLE; // ‚≠ê ÂÖ≥ÈîÆ
                send(`DISABLE AXIS ${i}`);
            }

            updateAxisUI(i);
        }


        function updateAxisUI(i) {
            const a = axis[i];

            const slider = document.getElementById(`slider${i}`);
            const rod = document.getElementById(`rod${i}`);
            const shell = document.getElementById(`shell${i}`);
            const homeBtn = document.getElementById(`homeBtn${i}`);

            let canMove = false;
            let rodColor = "#c62828";
            let homeClass = "home-idle";


            if (!a.enabled) {
                canMove = false;
                rodColor = "#c62828";
                homeClass = "home-idle";

            } else {
                switch (a.homeState) {
                    case HOME_IDLE:
                        canMove = false;
                        rodColor = "#777";
                        homeClass = "home-idle";
                        break;

                    case HOME_HOMING:
                        canMove = false;
                        rodColor = "#f9a825";
                        homeClass = "home-homing";
                        break;

                    case HOME_HOMED:
                        canMove = true;
                        rodColor = "#4CAF50";
                        homeClass = "home-homed";
                        break;
                    case HOME_FAILED:
                        canMove = false;
                        rodColor = "#f6010a";
                        homeClass = "home-failed";
                        break;
                }
            }

            slider.disabled = !canMove;
            rod.setAttribute("fill", rodColor);

            // ‚≠ê Home ÊåâÈíÆÈ¢úËâ≤ÊéßÂà∂
            homeBtn.classList.remove("home-idle", "home-homing", "home-homed", "home-failed");
            homeBtn.classList.add(homeClass);

            // === Â§ñÂ£≥ÊèèËæπÈ¢úËâ≤ÔºöEnable = ÁªøÔºåDisable = ÁÅ∞ ===
            shell.setAttribute(
                "stroke",
                a.enabled ? "#4CAF50" : "#777"
            );

        }


        function homeAxis(i) {
            if (!axis[i].enabled) return;

            axis[i].homeState = HOME_HOMING;
            updateAxisUI(i);

            send(`HOME AXIS ${i}`);

            /*
             * Áé∞Âú®ÂÖàÁî®‚ÄúÂÅáÂÆåÊàê‚Äù
             * ÂêéÈù¢ MCU Âõû‰º†Êó∂ÔºåÂè™Ë¶ÅÊää‰∏ãÈù¢ËøôË°å
             * ÊîæÂà∞Âõû‰º†Ëß£ÊûêÈáåÂç≥ÂèØ
             */
            setTimeout(() => {
                axis[i].homeState = HOME_HOMED;
                axis[i].target = 0;
                // axis[i].homeState = HOME_FAILED;
                // axis[i].target = 0;
                updateRod(i);
                updateAxisUI(i);
            }, 800);
        }

        function init() {
            for (let i = 0; i < AXIS_NUM; i++) {
                const btn = document.getElementById(`enBtn${i}`);
                btn.textContent = "ENABLED";
                btn.classList.remove("disable");
                btn.classList.add("enable");

                axis[i].enabled = true;
                axis[i].homeState = HOME_IDLE;


                updateAxisUI(i);

            }


        }

        init();

    </script>

</body>

</html>